stages:
  - test
  - build
  - build_android
  - deploy
  - release
  - changelog

variables:
  DEPLOY_PATH: /home/$DEPLOY_USER/web/$DEPLOY_DOMAIN/public_html
  GIT_DEPTH: 0  # Fetch all history and tags for version detection
  ANDROID_COMPILE_SDK: "36"
  ANDROID_BUILD_TOOLS: "35.0.0"
  ANDROID_SDK_TOOLS: "11076708"

test:
  stage: test
  image: node:20-alpine
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - node_modules/
  script:
    - npm ci
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

build:
  stage: build
  image: node:20-alpine
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - node_modules/
  script:
    - apk add --no-cache git
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

deploy:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build
  before_script:
    - apk add --no-cache rsync openssh-client
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - eval $(ssh-agent -s)
    - echo "" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  script:
    - rsync -avz --delete --chmod=D755,F644 dist/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
  only:
    - master
  environment:
    name: production
    url: https://$DEPLOY_DOMAIN

build_apk:
  stage: build_android
  image: ubuntu:24.04
  needs:
    - job: build
      artifacts: true
  before_script:
    - apt-get update -qy
    - apt-get install -y openjdk-21-jdk wget unzip curl ca-certificates gnupg
    # Install Node.js 22
    - mkdir -p /etc/apt/keyrings
    - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
    - echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
    - apt-get update -qy
    - apt-get install -y nodejs
    - node --version
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
    - export ANDROID_HOME="${PWD}/android-sdk"
    - export PATH="${PATH}:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools"
    # Install Android SDK
    - mkdir -p ${ANDROID_HOME}/cmdline-tools
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O android-sdk.zip
    - unzip -q android-sdk.zip -d ${ANDROID_HOME}/cmdline-tools
    - mv ${ANDROID_HOME}/cmdline-tools/cmdline-tools ${ANDROID_HOME}/cmdline-tools/latest
    - yes | sdkmanager --licenses || true
    - sdkmanager "platform-tools" "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"
    # Setup keystore from CI/CD variables
    - echo "${KEYSTORE_FILE}" | base64 -d > android/seal-release.keystore
    - echo "storePassword=${KEYSTORE_PASSWORD}" > android/keystore.properties
    - echo "keyPassword=${KEYSTORE_PASSWORD}" >> android/keystore.properties
    - echo "keyAlias=seal" >> android/keystore.properties
    - echo "storeFile=../seal-release.keystore" >> android/keystore.properties
    # Sync Capacitor with pre-built dist
    - npm ci
    - npx cap sync android
  script:
    - cd android
    - chmod +x ./gradlew
    - ./gradlew assembleRelease
  artifacts:
    paths:
      - android/app/build/outputs/apk/release/app-release.apk
    expire_in: 1 year
  only:
    - master

create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build_apk
      artifacts: true
  before_script:
    - apk add --no-cache git curl
  script:
    - LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
    - echo "Creating release for tag ${LATEST_TAG}"
    - APK_URL="${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_BRANCH}/raw/android/app/build/outputs/apk/release/app-release.apk?job=build_apk"
    # Check if release exists and delete it
    - |
      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${LATEST_TAG}")
      if [ "$HTTP_CODE" = "200" ]; then
        echo "Release exists, deleting..."
        curl --request DELETE \
          --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${LATEST_TAG}"
        sleep 2
      fi
    # Create release using API directly (more reliable than release-cli for updates)
    - |
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{
          \"tag_name\": \"${LATEST_TAG}\",
          \"name\": \"Release ${LATEST_TAG}\",
          \"description\": \"Automated release from CI/CD pipeline\",
          \"assets\": {
            \"links\": [{
              \"name\": \"Seal-Android.apk\",
              \"url\": \"${APK_URL}\",
              \"link_type\": \"package\"
            }]
          }
        }" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
  only:
    - master

changelog:
  stage: changelog
  image: alpine:latest
  variables:
    GIT_DEPTH: 0  # Volle Historie f√ºr Changelog
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache git curl
    # Install git-cliff
    - curl -sSL https://github.com/orhun/git-cliff/releases/download/v2.7.0/git-cliff-2.7.0-x86_64-unknown-linux-musl.tar.gz | tar -xzf -
    - mv git-cliff-*/git-cliff /usr/local/bin/
    - chmod +x /usr/local/bin/git-cliff
  script:
    # Configure git
    - git config user.email "ci@gitlab.com"
    - git config user.name "GitLab CI"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    # Fetch master branch to push changelog there
    - git fetch origin master:master || true
    - git checkout master
    # Generate changelog
    - git-cliff --output CHANGELOG.md
    # Check if changelog changed
    - |
      git add CHANGELOG.md
      if git diff --cached --quiet CHANGELOG.md; then
        echo "No changelog changes"
      else
        git commit -m "chore(release): update changelog [skip ci]"
        git push origin master
        echo "Changelog updated and pushed!"
      fi
  only:
    - tags
  when: on_success

include:
  - template: Security/SAST-IaC.latest.gitlab-ci.yml
