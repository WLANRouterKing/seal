stages:
  - test
  - build
  - deploy
  - changelog

variables:
  DEPLOY_PATH: /home/$DEPLOY_USER/web/$DEPLOY_DOMAIN/public_html
  GIT_DEPTH: 0  # Fetch all history and tags for version detection

test:
  stage: test
  image: node:20-alpine
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - node_modules/
  script:
    - npm ci
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

build:
  stage: build
  image: node:20-alpine
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - node_modules/
  script:
    - apk add --no-cache git
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

deploy:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build
  before_script:
    - apk add --no-cache rsync openssh-client
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - eval $(ssh-agent -s)
    - echo "" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
  script:
    - rsync -avz --delete --chmod=D755,F644 dist/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
  only:
    - master
  environment:
    name: production
    url: https://$DEPLOY_DOMAIN

changelog:
  stage: changelog
  image: alpine:latest
  variables:
    GIT_DEPTH: 0  # Volle Historie für Changelog
    GIT_STRATEGY: fetch
  before_script:
    - apk add --no-cache git curl
    # Install git-cliff
    - curl -sSL https://github.com/orhun/git-cliff/releases/download/v2.7.0/git-cliff-2.7.0-x86_64-unknown-linux-musl.tar.gz | tar -xzf -
    - mv git-cliff-*/git-cliff /usr/local/bin/
    - chmod +x /usr/local/bin/git-cliff
  script:
    # Debug - zeige verfügbare Commits
    - echo "Verfügbare Commits:"
    - git log --oneline -20
    # Configure git
    - git config user.email "ci@gitlab.com"
    - git config user.name "GitLab CI"
    - git remote set-url origin "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    # Generate changelog
    - git-cliff --output CHANGELOG.md
    - cat CHANGELOG.md
    # Check if changelog changed
    - |
      if git diff --quiet CHANGELOG.md 2>/dev/null; then
        echo "No changelog changes"
      else
        git add CHANGELOG.md
        git commit -m "chore(release): update changelog [skip ci]"
        git push origin HEAD:${CI_COMMIT_REF_NAME}
      fi
  only:
    - master
  when: on_success

include:
  - template: Security/SAST-IaC.latest.gitlab-ci.yml
